---
title: "Nanopore Direct RNA Seq - Practical"
author: "Anton Enright & Steph Wenlock"
date: \'`r format(Sys.time(), '%d %B, %Y')`\'
always_allow_html: yes
output:
  github_document:
    toc: true
---


```{r setup, results='hide',message=F, warning=F, echo=F}
require(knitr)
opts_knit$set(root.dir = '~/Desktop/course_data/direct_rna')
opts_chunk$set(dev="png", 
               dev.args=list(type="cairo"),
               comment='           ##',
               dpi=300)
```

# Analysis of Nanopore Direct RNA counts


First we should change directory to where the data is

```{r}
setwd("~/Desktop/course_data/direct_rna")
list.files()
```
# Analysis of Reads - Basic QC of sequencing runs

Will will use the PycoQC tool to make a QC summary for each set of Nanopore reads by group
```{}
pycoQC -f summaries/group_1_summary.txt -o group_1_summary.html
```

# Mapping of Reads

We will map reads directly to the transcriptome first to obtain accurate count data. Because we are mapping to cDNA we don't need to account for splicing and run minimap2
in the *map-ont* mode for long noisy reads. The reference data was obtained from Ensembl FTP. We use samtools to convert the text output (SAM) to a more efficient 
binary format (BAM) and also sort the BAM files to create efficient result files.

The mapping mode is *-ax map-ont* and we ask for two CPUs per job *-t 2*. We use *samtools* to help formatting the BAM files.
```{}
minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/scr1drna.fq.gz | samtools view -bh | samtools sort -o scr1drna.bam
minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/scr2drna.fq.gz | samtools view -bh | samtools sort -o scr2drna.bam
minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/scr3drna.fq.gz | samtools view -bh | samtools sort -o scr3drna.bam

minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/wt1drna.fq.gz | samtools view -bh | samtools sort -o wt1drna.bam
minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/wt2drna.fq.gz | samtools view -bh | samtools sort -o wt2drna.bam
minimap2 -ax map-ont -L -t 2 mouse_genome/Mus_musculus.GRCm39.cdna.all.fa.gz fastq/wt3drna.fq.gz | samtools view -bh | samtools sort -o wt3drna.bam
```


```{bash}
samtools view wt1drna.bam | head
```

# Genome Mapping

Typically genome browsers are useful to explore our sequences and see how they align to transcripts. However genome-browsers require data mapped to the entire mouse genome.
So we will also generate BAM files with a full splice-aware mapping of our direct RNA sequences to the mouse genome. Minimap2 will run in the splicing mode for this (*-ax splice*).
```{}
minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/scr1drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o scr1_genome.bam
minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/scr2drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o scr2_genome.bam
minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/scr3drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o scr3_genome.bam

minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/wt1drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o wt1_genome.bam
minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/wt2drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o wt2_genome.bam
minimap2 -ax splice -uf -k 14 -L -t 4 mouse_genome/Mus_musculus.GRCm39.dna_rm.primary_assembly.fa.gz fastq/wt3drna.fq.gz | samtools view -bh -F 2308 | samtools sort -o wt3_genome.bam
```

# IGV

We will now use the Integrated Genome Viewer (IGV) from the Broad Institute (MIT) to look at our samples. 
We will then load in the BAM files one at a time  in IGV and explore but we need to make an INDEX file for each genome bam first.

```{}
samtools index scr1_genome.bam
samtools index scr2_genome.bam
samtools index scr3_genome.bam

samtools index wt1_genome.bam
samtools index wt2_genome.bam
samtools index wt3_genome.bam
```

Now we can launch IGV. Start up IGV from your desktop and then make sure the mouse genome is selected.

# Creating counts
```{}
samtools view wt1drna.bam | cut -f 3 | uniq -c | sort -k1n > wt1.counts.txt
samtools view wt2drna.bam | cut -f 3 | uniq -c | sort -k1n > wt2.counts.txt
samtools view wt3drna.bam | cut -f 3 | uniq -c | sort -k1n > wt3.counts.txt

samtools view scr1drna.bam | cut -f 3 | uniq -c | sort -k1n > scr1.counts.txt
samtools view scr2drna.bam | cut -f 3 | uniq -c | sort -k1n > scr2.counts.txt
samtools view scr3drna.bam | cut -f 3 | uniq -c | sort -k1n > scr3.counts.txt
```


# Count Level Analysis

```{r}

# Load in the combined count tables
drna_counts = read.table("direct_rna_counts.txt",header=TRUE,row.names=1)
head(drna_counts)

# Remove '.counts.txt" from the end of the column names with gsub
colnames(drna_counts)=gsub(".counts.txt","",colnames(drna_counts))

# Generate counts for different categories
enolase=drna_counts["Enolase_ENO2_YHR174W_mRNA",]
unmapped=drna_counts["unmapped_read_mouse",]
mapped = apply(drna_counts[3:nrow(drna_counts),],2,sum)

# Plot the combined information as a stacked barplot
barplot(as.matrix(rbind(mapped,unmapped,enolase)),col=c("darkblue","grey","red"),las=2,cex.axis=0.6,main="Mapping Status")
legend("topright",legend = c("mapped","unmapped","Enolase"),fill=c("darkblue","grey","red"),cex=0.6)

barplot(mapped,col="darkblue",las=2,cex.axis=0.6,main="Total Mapped per Group")
```


```{r}

library(DESeq2)
library(RColorBrewer)
library(gplots)
library(Rtsne)
library(ggplot2)

conds=c("scr","scr","scr","wt","wt","wt")
coldata = as.data.frame(conds)
rownames(coldata)=colnames(drna_counts)
colnames(coldata)='treatment'
coldata

dds <- DESeqDataSetFromMatrix(countData = drna_counts, colData = coldata, design = ~ treatment)
dds <- estimateSizeFactors(dds)
dds <- estimateDispersions(dds)
plotDispEsts(dds)
```

```{r}
normcounts <- counts(dds, normalized=TRUE)
rawcounts=counts(dds,normalized=FALSE)
log2counts=log2(normcounts+1)
vsd <- varianceStabilizingTransformation(dds)
vstcounts <- assay(vsd)
vstcounts <- vstcounts[order(apply(vstcounts,1,sum),decreasing =TRUE),]

hmcol = colorRampPalette(brewer.pal(9, "GnBu"))(100)


barplot(apply(normcounts,2,sum), las=2,col=c("red","red","red","darkblue","darkblue","darkblue"),main="Post-Normalised Counts",cex.names=0.4)
legend("topright",levels(as.factor(conds)),cex=0.6,fill=c("red","darkblue"))

heatmap.2(cor(vstcounts),trace="none",col=hmcol,main="Sample to Sample Correlation (VST)",cexRow=0.5,cexCol=0.5,RowSideColors=c("red","red","red","darkblue","darkblue","darkblue"),margins=c(9,7))

pca2=prcomp(t(normcounts),center=TRUE)
plot(pca2$x, col=c("red","red","red","darkblue","darkblue","darkblue"),  pch=19, cex=2, main="Sample to Sample PCA (VST)")
text(pca2$x, as.vector(colnames(drna_counts)), pos=3, cex=0.4)
```

## tSNE plot
```{r}
tsne <- Rtsne(t(normcounts), perplexity = 1, check_duplicates = FALSE)
tsne.df <- data.frame(tsne.1 = tsne$Y[,1], tsne.2 = tsne$Y[,2])

ggplot(data = tsne.df, aes(tsne.1, tsne.2)) + 
  geom_point(size = 6, pch = 20, colour = c("red","red","red","darkblue","darkblue","darkblue")) +
  geom_text(size = 2, vjust=2, aes(label=colnames(vstcounts))) +
  scale_alpha_discrete(range = c(0.5, 1)) +
  theme_minimal() +
  ylab("tSNE 1") +
  xlab("tSNE 2") 
```

# Statistical Analysis

```{r}

p_threshold=0.05
lfc_threshold=0.75

cds <- nbinomWaldTest(dds)

res=results(cds,contrast=c("treatment","wt","scr"))
res <- res[order(res$padj),]
res

sig = rownames(res[(abs(res$log2FoldChange) > lfc_threshold) & (res$padj < p_threshold) & !is.na(res$padj),])

plot(res$log2FoldChange,-log(res$padj,10),ylab="-log10(Adjusted P)",xlab="Log2 FoldChange",main=paste("Volcano Plot","WT v Scr"),pch=19,cex=0.4)      
points(res[sig,"log2FoldChange"],-log(res[sig,"padj"],10),pch=19,cex=0.4,col="red")
abline(h=-log10(p_threshold),lty=3)
abline(v=-lfc_threshold,lty=3)
abline(v=lfc_threshold,lty=3)   

```